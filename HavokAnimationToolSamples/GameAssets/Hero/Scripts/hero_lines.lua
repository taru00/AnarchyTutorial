
--line data
g_lineWorld =
{		
	m_lineData = {
	
		-- blue
		-7.33232, -51.6513, 5.0, -10.8323, -51.6513, 5.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-6.58232, -47.4013, 5.0, -6.58232, -50.9013, 5.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-10.8323, -46.6513, 5.0, -7.33232, -46.6513, 5.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-11.5823, -50.9013, 5.0, -11.5823, -47.4013, 5.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2, 
		-33.753, -51.3642, 6.0, -39.4382, -49.0093, 6.0, 0.0, 0.0, 0.980785, 0.19509, -0.382683,-0.92388,0.0,2,
		-33.0601, -42.4013, 6.0, -33.0601, -50.9013, 6.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-0.582319, -48.4013, 7.0, -0.582319, -50.9013, 7.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-5.84253, -46.7746, 7.0, -1.32211, -47.528, 7.0, 0.0, 0.0, -0.0824805, 0.996593, 0.164399,0.986394,0.0,2,
		-6.58232, -50.9013, 7.0, -6.58232, -47.4013, 7.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2,
		-1.33232, -51.6513, 7.0, -5.83232, -51.6513, 7.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-41.5956, -24.3807, 2.0, -41.5956, -28.1507, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-45.8456, -23.6307, 2.0, -42.3456, -23.6307, 2.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-46.5956, -28.1507, 2.0, -46.5956, -24.3807, 2.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2,
		-42.3456, -28.9007, 2.0, -45.8456, -28.9007, 2.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-41.5956, -29.6507, 5.0, -41.5956, -35.1507, 5.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-45.8456, -28.9007, 5.0, -42.3456, -28.9007, 5.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-46.5956, -35.1507, 5.0, -46.5956, -29.6507, 5.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2,
		-42.3456, -35.9007, 5.0, -45.8456, -35.9007, 5.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-24.2923, -47.4013, 6.0, -24.2923, -50.9013, 6.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-28.5423, -46.6513, 6.0, -25.0423, -46.6513, 6.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-29.2923, -50.9013, 6.0, -29.2923, -47.4013, 6.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2,
		-25.0423, -51.6513, 6.0, -28.5423, -51.6513, 6.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-30.0549, -38.646, 3.0, -32.5298, -41.1209, 3.0, 0.0, 0.0, -0.92388, 0.382683, 0.707107,-0.707107,0.0,2,
		-32.5298, -35.1105, 3.0, -30.0549, -37.5854, 3.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,2,
		-36.0653, -37.5854, 3.0, -33.5904, -35.1105, 3.0, 0.0, 0.0, 0.382683, 0.92388, -0.707107,0.707107,0.0,2,
		-33.5904, -41.1209, 3.0, -36.0653, -38.6461, 3.0, 0.0, 0.0, 0.923879, 0.382684, -0.707107,-0.707107,0.0,2,
		-7.91254, 24.1361, 0.0, -11.6797, 24.8676, 0.0, 0.0, 0.0, 0.995405, 0.0957562, -0.190632,-0.981661,0.0,2,
		-23.6314, 27.1886, 0.0, -27.3985, 27.9201, 0.0, 0.0, 0.0, 0.995405, 0.0957562, -0.190632,-0.981661,0.0,2,
		-28.161, 23.9935, 0.0, -24.3939, 23.2619, 0.0, 0.0, 0.0, -0.0957562, 0.995405, 0.190632,0.981661,0.0,2,
		-12.4422, 20.941, 0.0, -8.67507, 20.2094, 0.0, 0.0, 0.0, -0.0957562, 0.995405, 0.190632,0.981661,0.0,2,
		-45.8456, -38.1157, 6.0, -37.3456, -38.1157, 6.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-43.9537, -44.4939, 6.0, -46.3086, -38.8086, 6.0, 0.0, 0.0, 0.831469, 0.55557, -0.92388,-0.382683,0.0,2,
		-36.0653, -38.6461, 6.0, -33.5904, -41.1209, 6.0, 0.0, 0.0, -0.382684, 0.923879, 0.707107,0.707107,0.0,2,
		-40.6615, -48.192, 6.0, -43.1364, -45.7171, 6.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,2,
		-7.13661, -40.9547, 2.0, -6.02803, -39.4545, 2.0, 0.0, 0.0, 0.4504, 0.892827, -0.804259,0.594279,0.0,2,
		-4.83232, -38.8513, 2.0, -4.33232, -38.8513, 2.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,2,
		-3.58232, -39.6013, 2.0, -3.58232, -42.1613, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,2,
		-7.58232, -42.1613, 2.0, -7.58232, -42.3079, 2.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,2,
		-4.33232, -42.9113, 2.0, -6.83232, -42.9113, 2.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-12.3323, -51.6513, 2.0, -23.5423, -51.6513, 2.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		-42.5456, -19.9007, 2.0, -45.6456, -19.9007, 2.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,2,
		
		-- goldenrod (orange-ish)
		-46.4456, -6.90073, 3.0, -46.4456, -19.8007, 3.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-56.4456, -6.90073, 1.00409, -56.4456, -17.9007, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-56.4456, -17.9007, 2.0, -56.4456, -19.7007, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-46.5956, -19.7507, 2.0, -56.3956, -19.7507, 2.0, 0.0, 0.0, 1.0, 0.0, 0.0,1.0,0.0,4,
		-51.4456, -6.90073, 3.0, -51.4456, -17.9007, 2.00412, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-31.7456, -17.9007, 2.0, -31.7456, -19.7007, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-31.7456, -6.90073, 1.00409, -31.7456, -17.9007, 2.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-41.7456, -6.90073, 3.0, -41.7456, -19.8007, 3.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-36.7456, -6.90073, 3.0, -36.7456, -17.9007, 2.00412, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-31.7956, -19.7507, 2.0, -41.5956, -19.7507, 2.0, 0.0, 0.0, 1.0, 0.0, 0.0,1.0,0.0,4,
		-36.7956, -5.05073, 3.0, -42.0956, -5.05073, 3.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,4,
		-46.0956, -5.05073, 3.0, -51.3956, -5.05073, 3.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,4,
		-27.8951, 14.6691, 1.06, -27.8951, 8.67909, 1.06, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-29.3872, 5.37141, 1.35, -29.3872, -2.53859, 1.35, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-33.7889, 20.4083, 0.88, -33.7889, 9.63831, 0.88, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-40.004, 11.6045, 1.21, -40.004, 1.96446, 1.21, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-40.9866, 19.7073, 0.83, -40.9866, 14.5273, 0.83, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		-34.9141, 4.38965, 0.86, -34.9141, -1.08035, 0.86, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,4,
		
		-- red
		-18.3761, -3.64701, 0.0, -18.6444, -3.37868, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707106,-0.707107,0.0,0,
		-19.0874, -3.82168, 0.0, -18.8191, -4.09001, 0.0, 0.0, 0.0, -0.382684, 0.92388, 0.707107,0.707107,0.0,0,
		-14.1496, -7.91646, 0.0, -15.4893, -6.5768, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,0,
		-15.8893, -6.97685, 0.0, -14.5496, -8.31651, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,0,
		-7.79571, -14.2934, 0.0, -11.2596, -10.8295, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,0,
		-11.6366, -11.2066, 0.0, -8.17275, -14.6704, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,0,
		-3.54299, -18.5231, 0.0, -4.88265, -17.1834, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,0,
		-5.2827, -17.5835, 0.0, -3.94305, -18.9231, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,0,
		-0.344875, -21.6782, 0.0, -0.613203, -21.4099, 0.0, 0.0, 0.0, 0.923879, 0.382684, -0.707107,-0.707107,0.0,0,
		-1.0562, -21.8529, 0.0, -0.787872, -22.1212, 0.0, 0.0, 0.0, -0.382684, 0.923879, 0.707107,0.707106,0.0,0,
		
		--green
		-18.7458, -12.5126, 0.0, -20.0854, -11.173, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,1,
		-20.4855, -11.573, 0.0, -19.1458, -12.9127, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,1,
		-22.9723, -8.24321, 0.0, -23.2406, -7.97488, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,1,
		-23.6836, -8.41787, 0.0, -23.4153, -8.6862, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,1,
		-12.3919, -18.8896, 0.0, -15.8557, -15.4257, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707107,-0.707107,0.0,1,
		-16.2328, -15.8027, 0.0, -12.7689, -19.2666, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,1,
		-8.13919, -23.1192, 0.0, -9.47884, -21.7796, 0.0, 0.0, 0.0, 0.92388, 0.382684, -0.707107,-0.707107,0.0,1,
		-9.8789, -22.1796, 0.0, -8.53924, -23.5193, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,1,
		-4.94107, -26.2744, 0.0, -5.2094, -26.0061, 0.0, 0.0, 0.0, 0.92388, 0.382683, -0.707106,-0.707107,0.0,1,
		-5.65239, -26.4491, 0.0, -5.38407, -26.7174, 0.0, 0.0, 0.0, -0.382683, 0.92388, 0.707107,0.707107,0.0,1,
		-12.9615, 26.1352, 0.0, -21.9683, 27.8843, 0.0, 0.0, 0.0, 0.995405, 0.0957565, -0.190633,-0.981661,0.0,3,
		-22.9214, 22.976, 0.0, -13.9147, 21.2269, 0.0, 0.0, 0.0, -0.0957566, 0.995405, 0.190633,0.981661,0.0,3,

		-- yellow
		8.66768, -47.1513, 10.25, 8.66768, -51.1513, 10.25, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,3,
		-1.08232, -46.4013, 10.25, 7.91768, -46.4013, 10.25, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,3,
		-1.83232, -51.1513, 10.25, -1.83232, -47.1513, 10.25, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,3,
		7.91768, -51.9013, 10.25, -1.08232, -51.9013, 10.25, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,3,
		-14.0423, -47.1513, 7.1, -14.0423, -51.1513, 7.1, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,3,
		-18.7923, -46.4013, 7.1, -14.7923, -46.4013, 7.1, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,3,
		-19.5423, -51.1513, 7.1, -19.5423, -47.1513, 7.1, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,3,
		-14.7923, -51.9013, 7.1, -18.7923, -51.9013, 7.1, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,3,
		8.66768, -33.4113, 5.0, 8.66768, -42.4113, 5.0, 0.0, 0.0, -0.707107, 0.707107, 1.0,0.0,0.0,3,
		-1.08232, -32.6613, 5.0, 7.91768, -32.6613, 5.0, 0.0, 0.0, 0.0, 1.0, 0.0,1.0,0.0,3,
		-1.83232, -42.4113, 5.0, -1.83232, -33.4113, 5.0, 0.0, 0.0, 0.707107, 0.707107, -1.0,0.0,0.0,3,
		7.91768, -43.1613, 5.0, -1.08232, -43.1613, 5.0, 0.0, 0.0, -1.0, 0.0, 0.0,-1.0,0.0,3 },
		
	m_numLines = 93,
	
}

-- Returns a line at index
function g_lineWorld:getLine( index )
	
	index = index - 1
	local record = index * 14
	local a = hkVector4.new(self.m_lineData[record + 1], self.m_lineData[record + 2], self.m_lineData[record + 3])
	local b = hkVector4.new(self.m_lineData[record + 4], self.m_lineData[record + 5], self.m_lineData[record + 6])
	local rotation = hkQuaternion.new(self.m_lineData[record + 7], self.m_lineData[record + 8], self.m_lineData[record + 9], self.m_lineData[record + 10])
	local edgeNormal = hkVector4.new(self.m_lineData[record + 11], self.m_lineData[record + 12], self.m_lineData[record + 13])
	local lineType = self.m_lineData[record + 14]
	return {m_a = a , m_b = b, m_rotation = rotation, m_edgeNormal = edgeNormal, m_lineType = lineType, m_index = index}
	
end

-- Returns a color based on the given box type
function getColorFromLineType( lineType )
	if ( lineType == 0 ) then
		return hkDebugDisplay.RED
	elseif ( lineType == 1 ) then
		return hkDebugDisplay.GREEN
	elseif (lineType == 2 ) then
		return hkDebugDisplay.BLUE
	elseif (lineType == 3 ) then
		return hkDebugDisplay.YELLOW
	elseif (lineType == 4 ) then
		return hkDebugDisplay.GOLDENROD
	elseif( lineType == 5 ) then
		return hkDebugDisplay.BLACK
	else
		return hkDebugDisplay.BLACK
	end
end

function drawDockLine( line, col)
	if(line.m_lineType ~= nil) then
		hkDebugDisplay.showLine(line.m_a, line.m_b, col)

		-- show edge normal
		if(line.m_edgeNormal ~= nil) then
		
			local midA = hkVector4.new()
			local midB = hkVector4.new()
			midA:setAdd4(line.m_a, line.m_b)		
			midA:mul4(0.5);
			midB:setAdd4(midA, line.m_edgeNormal)
			hkDebugDisplay.showLine( midA, midB, col )	
		end
	end
end

-- Draws all lines
function g_lineWorld:drawLines()
	
	if ( hkbGetVariable("ShowDockingLines") ) then
	
		for lineIndex = 1, self.m_numLines do
			local line = g_lineWorld:getLine(lineIndex)
			drawDockLine( line, getColorFromLineType( line.m_lineType ) )
		end
		
		if(g_characterState.m_dockingTarget ~= nil) then
			drawDockLine( g_characterState.m_dockingTarget, hkDebugDisplay.GOLDENROD )

		end
	end
		
end

function closestPointOnLineToCharacter(line)

	local u = hkVector4.new()
	local v = hkVector4.new()
	local closestPoint = hkVector4.new()
	
	u:setSub4(line.m_b, line.m_a)				
	v:setSub4(g_characterState.m_currentPos, line.m_a)		
	local length = u:normalizeWithLength3();					
	closestPoint:setAddMul4(line.m_a, u, clamp(u:dot3(v),0.0, length))
	
	return closestPoint
end

-- Find a line that the character can dock to.  If no line is found nil is returned
function g_lineWorld:findLineToDockTo(dockType, currentClosestLineDistance, disregardLine)
	
	local worldFromModel = hkbGetOldWorldFromModel()
	local closestLineIndex = -1
	local closestLineDistance = 10000000.0				
	
	-- assign the closest line distance if it was passed in
	if( (currentClosestLineDistance ~= nil) and (currentClosestLineDistance >= 0) ) then
		closestLineDistance = currentClosestLineDistance		
		
	end
			
	-- set the current position of the character if it has not yet been set
	if( g_characterState.m_currentPos == nil ) then
		g_characterState.m_currentPos = hkbGetOldWorldFromModel():getTranslation()
		
	end	
	
	
	for lineIndex = 1, self.m_numLines do
				
		local line = self:getLine(lineIndex)
		
		-- check that this isn't a line we are disregarding
		if ((disregardLine == nil)  or (disregardLine.m_index ~= lineIndex)) then
			
			local foundType = false
			
			-- make sure the appropriate box type has been passed in
			for typeIndex = 1, #dockType.m_lineTypes do
				
				if(dockType.m_lineTypes[typeIndex] == line.m_lineType) then
				
					foundType = true
					-- find the closest point on the line
					local u = hkVector4.new()
					local v = hkVector4.new()
					local closestPoint = hkVector4.new()
					
					u:setSub4(line.m_b, line.m_a)				
					v:setSub4(g_characterState.m_currentPos, line.m_a)		
					local length = u:normalizeWithLength3();				
					closestPoint:setAddMul4(line.m_a, u, clamp(u:dot3(v),0.0, length))
					
					-- calculate vector from closest point to the current pos
					local posMinusPoint = hkVector4.new()
					posMinusPoint:setSub4(g_characterState.m_currentPos, closestPoint) 
					local distance = posMinusPoint:length3()
					
					-- get the planar projection of the closestPointToPos vector
					local planarPosMinusPoint = hkVector4.new(posMinusPoint[0], posMinusPoint[1], 0)
					local planarDistance = planarPosMinusPoint:length3()
					
					-- only consider points that are within the distance ranges, and less than any previous distance found
					if ((distance < closestLineDistance) and (planarDistance < dockType.m_maxDistance) and (planarDistance >= dockType.m_minDistance)) then
						
						-- only consider points that satisfy the condition
						if( dockType.m_condition(posMinusPoint, g_characterState.m_currentPos, g_characterState.m_forward, line.m_edgeNormal) ) then
						
							-- store off the line index and distance
							closestLineIndex = lineIndex
							closestLineDistance = distance

						end
					end	
					break
				end
			end
		end
	end
	
	-- if we found a line return it, as well as the closest line distance
	if( closestLineIndex ~= -1 ) then		
		return g_lineWorld:getLine(closestLineIndex), closestLineDistance
		
	end
	
	return nil, closestLineDistance
	
end

function updateLineMovement( targetStyle )

	-- bail if there isn't a line to dock to
	if( g_characterState.m_dockingTarget == nil ) then
		return
	end
	
	if targetStyle.m_exitCondition() then
	
		-- exit
		targetStyle.m_exitFunction()
		
	else
	
		local moveDirection = g_characterState.m_dockedMoveDirection
		local dockedSpeed = g_characterState.m_dockedSpeed
		local dockedAcceleration = g_characterState.m_dockedAcceleration
		local maxSpeed = g_characterState.m_dockedMaxSpeed
		local lineParam = g_characterState.m_lineParam
			
		-- clamp if at the end of the line and still trying to move in that direction
		if( ((lineParam <= 0.01) and (moveDirection < 0)) or 
			((lineParam >= 0.99) and (moveDirection > 0)) or 
			(g_gamePad.m_padMagnitude < 0.1)  ) then
			
			dockedSpeed = dockedSpeed * 0.95
			
		else
			if( moveDirection > 0 ) then
				dockedSpeed = dockedSpeed + dockedAcceleration
			else  
				dockedSpeed = dockedSpeed - dockedAcceleration
			end				
		end
			
		-- check for a change in direction
		if( dockedSpeed < -0.2 and hkbIsNodeActive(targetStyle.m_leftNodeName) ) then
			hkbFireEvent("Move Right")
			if(targetStyle.m_movementVariableName ~= nil) then
				hkbSetVariable(targetStyle.m_movementVariableName, 0)
			end
		end
		if( dockedSpeed > 0.2 and hkbIsNodeActive(targetStyle.m_rightNodeName) ) then
			hkbFireEvent("Move Left")
			if(targetStyle.m_movementVariableName ~= nil) then
				hkbSetVariable(targetStyle.m_movementVariableName, 1)
			end
		end
				
		-- clamp within the valid range
		if( dockedSpeed > 0 ) then
			dockedSpeed = clamp(dockedSpeed, 0.0, maxSpeed);
		else
			dockedSpeed = clamp(dockedSpeed, -maxSpeed, 0.0);
		end
		
		-- save off the docked speed
		g_characterState.m_dockedSpeed = dockedSpeed
		hkbSetVariable("WalkSpeed", g_characterState.m_dockedSpeed)
		
	end

end